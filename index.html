<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Project Master (Pro)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- CSS è®Šæ•¸ --- */
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca;
            --bg-body: #f3f4f6; --bg-card: #ffffff; --bg-column: #f8fafc;
            --text-main: #111827; --text-sub: #6b7280;
            --border: #e5e7eb; --input-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --p-high: #ef4444; --p-medium: #f59e0b; --p-low: #10b981;
        }
        [data-theme="dark"] {
            --primary: #6366f1; --primary-hover: #818cf8;
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-column: #334155;
            --text-main: #f1f5f9; --text-sub: #94a3b8; --border: #334155; --input-bg: #1e293b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; transition: 0.3s; }
        button { cursor: pointer; font-family: inherit; transition: 0.2s; }
        input, select, textarea { background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border); outline: none; transition: 0.2s; }

        /* --- å°èˆª --- */
        .navbar { background-color: var(--bg-card); border-bottom: 1px solid var(--border); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .brand { font-size: 20px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .nav-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-btn { background: transparent; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; color: var(--text-main); font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .nav-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(79, 70, 229, 0.05); }
        .nav-btn.active:hover { color: white; background: var(--primary-hover); }

        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; }

        /* --- é¢æ¿ --- */
        .control-panel { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .panel-box { background: var(--bg-card); padding: 20px; border-radius: 10px; box-shadow: var(--shadow); border: 1px solid var(--border); flex: 1; min-width: 300px; }
        .panel-header { font-weight: 700; color: var(--text-sub); margin-bottom: 15px; display: flex; align-items: center; gap: 5px; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }
        
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; position: relative; }
        .input-group label { font-size: 11px; font-weight: 600; color: var(--text-sub); }
        input, select, textarea { padding: 8px 10px; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        
        .btn-primary { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; width: 100%; margin-top: 5px; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }

        /* --- Tag Menu --- */
        .tag-wrapper { position: relative; display: flex; }
        .tag-wrapper input { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; }
        .tag-btn { padding: 0 10px; border: 1px solid var(--border); border-left: none; border-top-right-radius: 6px; border-bottom-right-radius: 6px; background: var(--bg-column); color: var(--text-sub); font-size: 12px; }
        .tag-menu { position: absolute; top: 100%; right: 0; background: var(--bg-card); border: 1px solid var(--border); box-shadow: var(--shadow); border-radius: 6px; z-index: 50; width: 180px; margin-top: 5px; display: none; }
        .tag-menu.show { display: block; }
        .tag-option { padding: 8px 12px; font-size: 13px; cursor: pointer; }
        .tag-option:hover { background: var(--bg-column); color: var(--primary); }

        /* --- çœ‹æ¿ (Kanban) --- */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; align-items: flex-start; padding-bottom: 30px; min-height: 500px; }
        .column { flex: 1; min-width: 280px; max-width: 350px; background: var(--bg-column); border-radius: 12px; padding: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; max-height: 80vh; transition: 0.3s; }
        .column-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-weight: 700; color: var(--text-sub); font-size: 14px; padding: 0 5px; }
        .task-list { overflow-y: auto; flex: 1; padding: 2px; min-height: 100px; }

        /* Focus Mode: Hide Done and Blocked */
        .kanban-board.focus-mode #col-blocked, 
        .kanban-board.focus-mode #col-done { display: none; }

        /* --- æ—¥æ›† (Calendar) --- */
        #calendar-view { display: none; background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .calendar-day-header { font-weight: bold; text-align: center; color: var(--text-sub); padding-bottom: 10px; }
        .calendar-day { min-height: 100px; border: 1px solid var(--border); border-radius: 6px; padding: 5px; background: var(--bg-column); position: relative; }
        .calendar-day.today { border-color: var(--primary); background: rgba(79, 70, 229, 0.05); }
        .day-num { font-weight: bold; font-size: 12px; margin-bottom: 5px; display: block; }
        .cal-task { font-size: 10px; background: var(--bg-card); border-left: 3px solid var(--primary); padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .cal-task.done { text-decoration: line-through; opacity: 0.6; border-left-color: var(--p-low); }

        /* --- Task Card --- */
        .task-card { background: var(--bg-card); border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: var(--shadow); border: 1px solid var(--border); cursor: pointer; position: relative; transition: all 0.2s; border-left: 4px solid transparent; }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .task-card.overdue { border: 1px solid #ef4444 !important; border-left: 4px solid #ef4444 !important; background: #fff5f5; }
        [data-theme="dark"] .task-card.overdue { background: #451a1a; }
        
        .card-img { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; display: none; }
        .card-img.show { display: block; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #e0e7ff; color: var(--primary); font-weight: 600; }
        .card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 12px; color: var(--text-sub); }
        .avatar { width: 24px; height: 24px; border-radius: 50%; background: #e0e7ff; color: #4f46e5; display: flex; justify-content: center; align-items: center; font-size: 10px; font-weight: bold; }

        /* --- Modal --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); backdrop-filter: blur(3px); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: 0.2s; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-card); width: 700px; max-width: 95%; max-height: 90vh; border-radius: 12px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); position: relative; overflow-y: auto; display:flex; flex-direction:column; gap:15px; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: var(--text-sub); }

        .timer-box { background: var(--bg-column); padding: 10px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); }
        .checklist-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .checklist-item.done span { text-decoration: line-through; color: var(--text-sub); opacity: 0.6; }

        /* Attachments */
        .attachment-list { list-style: none; padding: 0; margin-top: 5px; }
        .attachment-item { display: flex; align-items: center; gap: 10px; padding: 6px; background: var(--bg-column); border-radius: 6px; font-size: 13px; margin-bottom: 5px; border: 1px solid var(--border); }
        .attachment-item a { flex: 1; text-decoration: none; color: var(--primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Comments */
        .comments-section { margin-top: 10px; border-top: 1px solid var(--border); padding-top: 15px; }
        .comment-list { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
        .comment-item { background: var(--bg-column); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
        .comment-header { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px; color: var(--text-sub); font-weight: 600; }
        .comment-input-box { display: flex; gap: 10px; }
        
        .chart-container { position: relative; height: 300px; width: 100%; }
        .log-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .log-item { padding: 8px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text-sub); display: flex; justify-content: space-between; }
        .hidden { display: none !important; }
        .shortcuts-hint { position: fixed; bottom: 10px; right: 10px; font-size: 11px; color: var(--text-sub); opacity: 0.7; pointer-events: none; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="brand">âš¡ Project Master</div>
    <div class="nav-actions">
        <button class="nav-btn active" id="btn-view-kanban" onclick="switchView('kanban')"><span data-i18n="view_kanban">ğŸ“‹ çœ‹æ¿</span></button>
        <button class="nav-btn" id="btn-view-calendar" onclick="switchView('calendar')"><span data-i18n="view_cal">ğŸ“… æ—¥æ›†</span></button>
        
        <div style="width: 1px; height: 20px; background: var(--border); margin: 0 5px;"></div>

        <button class="nav-btn" onclick="sortTasks()"><span data-i18n="btn_sort">ğŸš¨ æ’åº</span></button>
        <button class="nav-btn" onclick="toggleFocusMode()" id="btn-focus"><span data-i18n="btn_focus">ğŸ‘€ å°ˆæ³¨</span></button>
        
        <div style="width: 1px; height: 20px; background: var(--border); margin: 0 5px;"></div>

        <button class="nav-btn" onclick="toggleLanguage()">ğŸŒ <span id="lang-btn-text">ä¸­/EN</span></button>
        <button class="nav-btn" onclick="openDashboard()"><span data-i18n="nav_dash">ğŸ“Š</span></button>
        <button class="nav-btn" onclick="openLogModal()"><span data-i18n="nav_log">ğŸ“œ</span></button>
        <button class="nav-btn" onclick="openTeamModal()"><span data-i18n="nav_team">ğŸ‘¥</span></button>
        <button class="nav-btn" onclick="toggleTheme()">ğŸŒ™</button>
        <button class="nav-btn" onclick="exportData()">â¬‡ï¸</button>
        <button class="nav-btn" onclick="document.getElementById('fileInput').click()">â¬†ï¸</button>
        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="importData(event)">
    </div>
</nav>

<div class="container">
    <div id="kanban-wrapper">
        <div class="control-panel">
            <div class="panel-box">
                <div class="panel-header" data-i18n="search_title">ğŸ” æœå°‹èˆ‡ç¯©é¸</div>
                <div class="form-row">
                    <div class="input-group" style="flex:2">
                        <input type="text" id="s-text" data-ph="ph_keyword" placeholder="è¼¸å…¥é—œéµå­—..." oninput="renderKanban()">
                    </div>
                    <div class="input-group">
                        <select id="s-member" onchange="renderKanban()"><option value="" data-i18n="all_members">æ‰€æœ‰æˆå“¡</option></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <input type="text" id="s-tag" data-ph="ph_filter_tag" placeholder="éæ¿¾æ¨™ç±¤..." oninput="renderKanban()">
                    </div>
                </div>
            </div>

            <div class="panel-box">
                <div class="panel-header" data-i18n="add_title">â• å¿«é€Ÿæ–°å¢ (Hotkeys: 'N')</div>
                <div class="form-row">
                    <div class="input-group" style="flex:2">
                        <input type="text" id="t-name" data-ph="ph_task_name" placeholder="ä»»å‹™åç¨±...">
                    </div>
                    <div class="input-group">
                        <select id="t-priority">
                            <option value="High">ğŸ”´ Urgent</option>
                            <option value="Medium" selected>ğŸŸ¡ Normal</option>
                            <option value="Low">ğŸŸ¢ Low</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group" style="position:relative;">
                        <label data-i18n="lbl_tags">æ¨™ç±¤</label>
                        <div class="tag-wrapper">
                            <input type="text" id="t-tags" data-ph="ph_tags" placeholder="æ¨™ç±¤...">
                            <button class="tag-btn" onclick="toggleTagMenu('menu-t-tags')">â–¼</button>
                        </div>
                        <div id="menu-t-tags" class="tag-menu">
                            <div class="tag-option" onclick="addTag('t-tags', 'ğŸ› Bug')">ğŸ› Bug</div>
                            <div class="tag-option" onclick="addTag('t-tags', 'âœ¨ Feature')">âœ¨ Feature</div>
                            <div class="tag-option" onclick="addTag('t-tags', 'ğŸ”¥ Urgent')">ğŸ”¥ Urgent</div>
                            <div class="tag-option" onclick="addTag('t-tags', 'ğŸ¨ Design')">ğŸ¨ Design</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label data-i18n="lbl_img">åœ–ç‰‡</label>
                        <input type="text" id="t-img" data-ph="ph_img_url" placeholder="URL...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group"><select id="t-assignee"><option value="" data-i18n="unassigned">(æœªæŒ‡æ´¾)</option></select></div>
                    <div class="input-group"><input type="date" id="t-end"></div>
                </div>
                <button class="btn-primary" onclick="addTask()" data-i18n="btn_add">æ–°å¢ä»»å‹™</button>
            </div>
        </div>

        <div class="kanban-board" id="main-board">
            <div class="column" id="col-todo"><div class="column-header"><span data-i18n="col_todo">ğŸ“‹ å¾…è¾¦</span> <span id="c-todo">0</span></div><div class="task-list" id="todo" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
            <div class="column" id="col-inprogress"><div class="column-header"><span data-i18n="col_inprogress">âš¡ é€²è¡Œä¸­</span> <span id="c-inprogress">0</span></div><div class="task-list" id="inprogress" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
            <div class="column" id="col-onhold"><div class="column-header"><span data-i18n="col_onhold">â¸ï¸ æš«åœ</span> <span id="c-onhold">0</span></div><div class="task-list" id="onhold" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
            <div class="column" id="col-blocked"><div class="column-header" style="color:var(--p-high);"><span data-i18n="col_blocked">â›” å¡é—œ</span> <span id="c-blocked">0</span></div><div class="task-list" id="blocked" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
            <div class="column" id="col-done"><div class="column-header"><span data-i18n="col_done">âœ… å®Œæˆ</span> <span id="c-done">0</span></div><div class="task-list" id="done" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
        </div>
    </div>

    <div id="calendar-view">
        <div class="calendar-header">
            <h2 id="cal-title" style="margin:0">Month Year</h2>
            <div>
                <button class="nav-btn" onclick="changeMonth(-1)">â—€</button>
                <button class="nav-btn" onclick="changeMonth(1)">â–¶</button>
            </div>
        </div>
        <div class="calendar-grid">
            <div class="calendar-day-header">Sun</div><div class="calendar-day-header">Mon</div><div class="calendar-day-header">Tue</div><div class="calendar-day-header">Wed</div><div class="calendar-day-header">Thu</div><div class="calendar-day-header">Fri</div><div class="calendar-day-header">Sat</div>
            </div>
        <div id="calendar-body" class="calendar-grid" style="margin-top:5px;"></div>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('taskModal')">Ã—</button>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-right:30px;">
            <h2 id="m-title" style="margin:0;">Task Title</h2>
            <button onclick="cloneTask()" style="background:#e0e7ff; color:var(--primary); border:none; padding:5px 10px; border-radius:4px; font-size:12px;" data-i18n="btn_clone">Â©ï¸ è¤‡è£½</button>
        </div>

        <div class="timer-box">
            <div style="display:flex; align-items:center; gap:10px;"><span>â±ï¸ Timer:</span> <span id="m-time-display" class="time-display">0h 0m 0s</span></div>
            <button id="m-timer-btn" onclick="toggleTimer()" style="background:var(--primary); color:white; border:none; padding:5px 15px; border-radius:4px;">â–¶ Start</button>
        </div>
        
        <div class="form-row">
            <div class="input-group"><label data-i18n="lbl_status">ç‹€æ…‹</label><select id="m-status" onchange="updateTaskStatus()"><option value="todo">ğŸ“‹ To Do</option><option value="inprogress">âš¡ In Progress</option><option value="onhold">â¸ï¸ On Hold</option><option value="blocked">â›” Blocked</option><option value="done">âœ… Done</option></select></div>
            <div class="input-group"><label data-i18n="lbl_assignee">è² è²¬äºº</label><select id="m-assignee" onchange="updateTaskMeta()"></select></div>
            <div class="input-group"><label data-i18n="lbl_priority">å„ªå…ˆç´š</label><select id="m-priority" onchange="updateTaskMeta()"><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
        </div>

        <div class="form-row">
            <div class="input-group" style="position:relative;">
                <label data-i18n="lbl_tags">æ¨™ç±¤</label>
                <div class="tag-wrapper">
                    <input type="text" id="m-tags" onchange="updateTaskMeta()">
                    <button class="tag-btn" onclick="toggleTagMenu('menu-m-tags')">â–¼</button>
                </div>
                <div id="menu-m-tags" class="tag-menu">
                    <div class="tag-option" onclick="addTag('m-tags', 'ğŸ› Bug', true)">ğŸ› Bug</div>
                    <div class="tag-option" onclick="addTag('m-tags', 'âœ¨ Feature', true)">âœ¨ Feature</div>
                    <div class="tag-option" onclick="addTag('m-tags', 'ğŸ”¥ Urgent', true)">ğŸ”¥ Urgent</div>
                </div>
            </div>
            <div class="input-group"><label data-i18n="lbl_img">åœ–ç‰‡</label><input type="text" id="m-img" onchange="updateTaskMeta()"></div>
        </div>

        <div class="input-group">
            <label data-i18n="lbl_attach">ğŸ“ é™„ä»¶ (Attachments)</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="attach-link" placeholder="è¼¸å…¥é€£çµ (e.g. Google Drive)..." style="flex:2;">
                <label class="btn-primary" style="width:auto; margin:0; cursor:pointer; font-size:12px; display:flex; align-items:center;">
                    ğŸ“‚ Upload <input type="file" id="attach-file-fake" style="display:none;" onchange="fakeUploadFile(this)">
                </label>
                <button class="btn-primary" style="width:auto; margin:0;" onclick="addAttachmentLink()" data-i18n="btn_join">Add Link</button>
            </div>
            <ul id="attachment-list" class="attachment-list"></ul>
        </div>

        <div class="input-group">
            <label data-i18n="lbl_desc">ğŸ“ è©³ç´°æè¿°</label>
            <textarea id="m-desc" placeholder="..." onchange="updateTaskMeta()"></textarea>
        </div>

        <div style="background:var(--bg-column); padding:15px; border-radius:8px;">
            <h4 style="margin:0 0 10px 0;">âœ… Checklist</h4>
            <div style="height:6px; background:#ddd; border-radius:3px; overflow:hidden; margin-bottom:10px;"><div id="m-progress-bar" style="height:100%; width:0%; background:var(--p-low); transition:0.3s;"></div></div>
            <ul id="m-checklist" style="list-style:none; padding:0; margin:0;"></ul>
            <div style="display:flex; margin-top:10px; gap:5px;"><input type="text" id="new-check-item" data-ph="ph_subtask" placeholder="æ–°å¢ç´°é …..." style="flex:1;" onkeypress="if(event.key==='Enter') addCheckItem()"><button onclick="addCheckItem()" style="background:var(--primary); color:white; border:none; padding:5px 15px; border-radius:4px;">ï¼‹</button></div>
        </div>

        <div class="comments-section">
            <h4 style="margin:0 0 10px 0;" data-i18n="lbl_comments">ğŸ’¬ ç•™è¨€</h4>
            <ul id="comment-list" class="comment-list"></ul>
            <div class="comment-input-box">
                <input type="text" id="new-comment" placeholder="..." onkeypress="if(event.key==='Enter') addComment()">
                <button class="btn-primary" style="width:auto; margin:0;" onclick="addComment()">Send</button>
            </div>
        </div>
        
        <div style="text-align:right;"><button onclick="deleteCurrentTask()" style="color:#ef4444; background:none; border:none; text-decoration:underline;" data-i18n="btn_delete">åˆªé™¤ä»»å‹™</button></div>
        <input type="hidden" id="current-task-id">
    </div>
</div>

<div id="dashboardModal" class="modal"><div class="modal-content"><button class="close-btn" onclick="closeModal('dashboardModal')">Ã—</button><h2 data-i18n="nav_dash">ğŸ“ˆ å„€è¡¨æ¿</h2><div style="display:flex; gap:20px; flex-wrap:wrap;"><div style="flex:1; min-width:250px;"><h4 data-i18n="chart_status">ä»»å‹™ç‹€æ…‹</h4><div class="chart-container"><canvas id="statusChart"></canvas></div></div><div style="flex:1; min-width:250px;"><h4 data-i18n="chart_workload">å·¥ä½œé‡</h4><div class="chart-container"><canvas id="memberChart"></canvas></div></div></div></div></div>
<div id="logModal" class="modal"><div class="modal-content"><button class="close-btn" onclick="closeModal('logModal')">Ã—</button><div style="display:flex; justify-content:space-between; align-items:center;"><h2 data-i18n="log_title">ğŸ“œ æ—¥èªŒ</h2><button onclick="clearLog()" style="font-size:12px; color:red; background:none; border:none;" data-i18n="btn_clear_log">æ¸…ç©º</button></div><ul id="log-list" class="log-list"></ul></div></div>
<div id="teamModal" class="modal"><div class="modal-content"><button class="close-btn" onclick="closeModal('teamModal')">Ã—</button><h2 data-i18n="team_title">ğŸ‘¥ è¨­å®šéšŠå“¡</h2><div style="display:flex; gap:10px; margin-bottom:15px;"><input type="text" id="new-member-name" data-ph="ph_name" placeholder="è¼¸å…¥åå­—..." style="flex:1;"><button class="btn-primary" style="width:auto;" onclick="addMember()" data-i18n="btn_join">åŠ å…¥</button></div><div id="team-list-display" style="display:flex; flex-wrap:wrap; gap:10px;"></div></div></div>
<div class="shortcuts-hint">Hotkeys: [N] New Task | [Esc] Close Modal</div>

<script>
    const i18n = {
        zh: { nav_dash:"ğŸ“ˆ å„€è¡¨æ¿",nav_log:"ğŸ“œ æ—¥èªŒ",nav_team:"ğŸ‘¥ éšŠå“¡",nav_backup:"â¬‡ï¸ å‚™ä»½",nav_restore:"â¬†ï¸ é‚„åŸ",search_title:"ğŸ” æœå°‹èˆ‡ç¯©é¸",ph_keyword:"è¼¸å…¥é—œéµå­—...",all_members:"æ‰€æœ‰æˆå“¡",ph_filter_tag:"éæ¿¾æ¨™ç±¤...",add_title:"â• å¿«é€Ÿæ–°å¢",ph_task_name:"ä»»å‹™åç¨±...",ph_tags:"æ¨™ç±¤...",ph_img_url:"åœ–ç‰‡ URL...",unassigned:"(æœªæŒ‡æ´¾)",btn_add:"æ–°å¢ä»»å‹™",col_todo:"ğŸ“‹ å¾…è¾¦",col_inprogress:"âš¡ é€²è¡Œä¸­",col_onhold:"â¸ï¸ æš«åœ",col_blocked:"â›” å¡é—œ",col_done:"âœ… å®Œæˆ",btn_clone:"Â©ï¸ è¤‡è£½",lbl_status:"ç‹€æ…‹",lbl_assignee:"è² è²¬äºº",lbl_priority:"å„ªå…ˆç´š",lbl_tags:"æ¨™ç±¤",lbl_img:"åœ–ç‰‡",ph_subtask:"æ–°å¢ç´°é …...",btn_delete:"åˆªé™¤ä»»å‹™",chart_status:"ä»»å‹™ç‹€æ…‹åˆ†ä½ˆ",chart_workload:"è² è²¬äººå·¥ä½œé‡",log_title:"ğŸ“œ æ´»å‹•æ—¥èªŒ",btn_clear_log:"æ¸…ç©º",team_title:"ğŸ‘¥ è¨­å®šéšŠå“¡",ph_name:"è¼¸å…¥åå­—...",btn_join:"åŠ å…¥", lbl_desc:"ğŸ“ è©³ç´°æè¿°", lbl_comments:"ğŸ’¬ ç•™è¨€", view_kanban:"ğŸ“‹ çœ‹æ¿", view_cal:"ğŸ“… æ—¥æ›†", btn_sort:"ğŸš¨ æ’åº", btn_focus:"ğŸ‘€ å°ˆæ³¨", lbl_attach:"ğŸ“ é™„ä»¶" },
        en: { nav_dash:"ğŸ“ˆ Dashboard",nav_log:"ğŸ“œ Logs",nav_team:"ğŸ‘¥ Team",nav_backup:"â¬‡ï¸ Backup",nav_restore:"â¬†ï¸ Restore",search_title:"ğŸ” Search & Filter",ph_keyword:"Keyword...",all_members:"All Members",ph_filter_tag:"Filter tag...",add_title:"â• Quick Add",ph_task_name:"Task Name...",ph_tags:"Tags...",ph_img_url:"Image URL...",unassigned:"(Unassigned)",btn_add:"Add Task",col_todo:"ğŸ“‹ To Do",col_inprogress:"âš¡ In Progress",col_onhold:"â¸ï¸ On Hold",col_blocked:"â›” Blocked",col_done:"âœ… Done",btn_clone:"Â©ï¸ Clone",lbl_status:"Status",lbl_assignee:"Assignee",lbl_priority:"Priority",lbl_tags:"Tags",lbl_img:"Image",ph_subtask:"Add subtask...",btn_delete:"Delete Task",chart_status:"Status Distribution",chart_workload:"Member Workload",log_title:"ğŸ“œ Activity Log",btn_clear_log:"Clear",team_title:"ğŸ‘¥ Team Settings",ph_name:"Enter name...",btn_join:"Add", lbl_desc:"ğŸ“ Description", lbl_comments:"ğŸ’¬ Comments", view_kanban:"ğŸ“‹ Kanban", view_cal:"ğŸ“… Calendar", btn_sort:"ğŸš¨ Sort", btn_focus:"ğŸ‘€ Focus", lbl_attach:"ğŸ“ Attachments" }
    };
    let currentLang = localStorage.getItem('lang') || 'zh';

    let tasks = JSON.parse(localStorage.getItem('v13_tasks')) || [];
    let members = JSON.parse(localStorage.getItem('v13_members')) || ['Me'];
    let activities = JSON.parse(localStorage.getItem('v13_activities')) || [];

    // Migration v12
    if (tasks.length === 0 && localStorage.getItem('v12_tasks')) {
        tasks = JSON.parse(localStorage.getItem('v12_tasks'));
        members = JSON.parse(localStorage.getItem('v12_members'));
    }
    if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('t-end').valueAsDate = new Date();

    let calDate = new Date();
    let isSorted = false;
    let isFocus = false;

    applyLanguage(); renderMembers(); renderKanban(); setInterval(updateTimerDisplay, 1000);

    // Shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
        if (e.key.toLowerCase() === 'n' && !e.target.matches('input,textarea')) document.getElementById('t-name').focus();
    });

    // View Switcher
    function switchView(view) {
        document.getElementById('kanban-wrapper').style.display = view==='kanban' ? 'block' : 'none';
        document.getElementById('calendar-view').style.display = view==='calendar' ? 'block' : 'none';
        document.getElementById('btn-view-kanban').classList.toggle('active', view==='kanban');
        document.getElementById('btn-view-calendar').classList.toggle('active', view==='calendar');
        if(view==='calendar') renderCalendar();
    }

    // Auto Sort (Priority)
    function sortTasks() {
        isSorted = !isSorted;
        const btn = document.querySelector('button[onclick="sortTasks()"]');
        btn.style.background = isSorted ? 'var(--primary)' : 'transparent';
        btn.style.color = isSorted ? 'white' : 'var(--text-main)';
        renderKanban();
    }

    // Focus Mode
    function toggleFocusMode() {
        isFocus = !isFocus;
        const board = document.getElementById('main-board');
        const btn = document.getElementById('btn-focus');
        if(isFocus) {
            board.classList.add('focus-mode');
            btn.style.background = 'var(--primary)'; btn.style.color = 'white';
        } else {
            board.classList.remove('focus-mode');
            btn.style.background = 'transparent'; btn.style.color = 'var(--text-main)';
        }
    }

    // Calendar Logic
    function renderCalendar() {
        const body = document.getElementById('calendar-body');
        body.innerHTML = '';
        const year = calDate.getFullYear();
        const month = calDate.getMonth();
        document.getElementById('cal-title').innerText = new Date(year, month).toLocaleString(currentLang, { month:'long', year:'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const todayStr = new Date().toISOString().split('T')[0];

        // Empty cells
        for(let i=0; i<firstDay; i++) body.innerHTML += `<div class="calendar-day" style="background:transparent;border:none;"></div>`;

        // Days
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isToday = dateStr === todayStr;
            let html = `<div class="calendar-day ${isToday?'today':''}">
                <span class="day-num">${d}</span>`;
            
            // Find tasks for this day
            tasks.filter(t => t.end === dateStr).forEach(t => {
                html += `<div class="cal-task ${t.status==='done'?'done':''}" onclick="openTaskModal('${t.id}')">${t.name}</div>`;
            });
            html += `</div>`;
            body.innerHTML += html;
        }
    }
    function changeMonth(delta) {
        calDate.setMonth(calDate.getMonth() + delta);
        renderCalendar();
    }

    // Tag Menu
    function toggleTagMenu(id) {
        const menu = document.getElementById(id);
        const isVisible = menu.style.display === 'block';
        document.querySelectorAll('.tag-menu').forEach(el => el.style.display = 'none');
        menu.style.display = isVisible ? 'none' : 'block';
    }
    document.addEventListener('click', function(e) { if (!e.target.closest('.tag-wrapper')) document.querySelectorAll('.tag-menu').forEach(el => el.style.display = 'none'); });
    function addTag(inputId, tag, isUpdateMeta = false) {
        const input = document.getElementById(inputId);
        let currentTags = input.value.split(',').map(t=>t.trim()).filter(t=>t);
        if(!currentTags.includes(tag)) { currentTags.push(tag); input.value = currentTags.join(', '); if(isUpdateMeta) updateTaskMeta(); }
        document.querySelectorAll('.tag-menu').forEach(el => el.style.display = 'none');
    }

    function toggleLanguage() { currentLang = currentLang === 'zh' ? 'en' : 'zh'; localStorage.setItem('lang', currentLang); applyLanguage(); }
    function applyLanguage() {
        document.getElementById('lang-btn-text').innerText = currentLang === 'zh' ? 'ä¸­/EN' : 'EN/ä¸­';
        document.querySelectorAll('[data-i18n]').forEach(el => { const k=el.getAttribute('data-i18n'); if(i18n[currentLang][k]) el.innerText=i18n[currentLang][k]; });
        document.querySelectorAll('[data-ph]').forEach(el => { const k=el.getAttribute('data-ph'); if(i18n[currentLang][k]) el.placeholder=i18n[currentLang][k]; });
        if(document.getElementById('calendar-view').style.display === 'block') renderCalendar();
    }

    function addTask() {
        const name = document.getElementById('t-name').value;
        if (!name) return alert(currentLang==='zh'?"è«‹è¼¸å…¥åç¨±":"Name required");
        const tags = document.getElementById('t-tags').value.split(',').map(t=>t.trim()).filter(t=>t);
        tasks.push({ id:'t'+Date.now(), name, priority:document.getElementById('t-priority').value, assignee:document.getElementById('t-assignee').value||'', end:document.getElementById('t-end').value, tags, img:document.getElementById('t-img').value, status:'todo', checklist:[], timer:{totalSeconds:0,isRunning:false}, desc:'', comments:[], attachments:[] });
        logActivity(`New Task: "${name}"`); saveAndRender();
        document.getElementById('t-name').value = ''; document.getElementById('t-tags').value = '';
    }

    function renderKanban() {
        const sT=document.getElementById('s-text').value.toLowerCase(), sM=document.getElementById('s-member').value, sTg=document.getElementById('s-tag').value.toLowerCase();
        ['todo','inprogress','onhold','blocked','done'].forEach(id => document.getElementById(id).innerHTML = '');
        let c={todo:0,inprogress:0,onhold:0,blocked:0,done:0};

        // Filter
        let filteredTasks = tasks.filter(t => {
            if(sT && !t.name.toLowerCase().includes(sT)) return false;
            if(sM && t.assignee !== sM) return false;
            if(sTg && (!t.tags || !t.tags.some(Tag=>Tag.toLowerCase().includes(sTg)))) return false;
            return true;
        });

        // Sort Logic (High->Medium->Low)
        if (isSorted) {
            const pMap = { 'High':3, 'Medium':2, 'Low':1 };
            filteredTasks.sort((a,b) => pMap[b.priority] - pMap[a.priority]);
        }

        filteredTasks.forEach(t => {
            c[t.status]++;
            const card=document.createElement('div'); card.className='task-card '+(t.status!=='done'&&t.end&&new Date(t.end)<new Date().setHours(0,0,0,0)?'overdue':'');
            card.draggable=true; card.id=t.id; card.onclick=()=>openTaskModal(t.id); card.ondragstart=(ev)=>ev.dataTransfer.setData("text",ev.target.id);
            const img=t.img?`<img src="${t.img}" class="card-img show" onerror="this.style.display='none'">`:'';
            const tags=t.tags?t.tags.map(Tag=>`<span class="tag">${Tag}</span>`).join(''):'';
            const check=`${t.checklist?t.checklist.filter(i=>i.done).length:0}/${t.checklist?t.checklist.length:0}`;
            const av=t.assignee?`<div class="avatar">${t.assignee[0].toUpperCase()}</div>`:'';
            const attIcon = (t.attachments && t.attachments.length>0) ? 'ğŸ“' : '';
            card.innerHTML=`${img}<div class="card-tags">${tags}</div><div class="card-top"><span class="badge bg-${t.priority.toLowerCase()}">${t.priority}</span> <span>${(t.timer&&t.timer.totalSeconds>0)?'â±ï¸':''} ${attIcon}</span></div><div style="font-weight:600;font-size:14px;margin-bottom:5px;">${t.name}</div><div class="card-meta"><div class="meta-left">${t.checklist&&t.checklist.length>0?'â˜‘ '+check:''} ${(t.comments&&t.comments.length>0)?'ğŸ’¬ '+t.comments.length:''}</div>${av}</div>`;
            document.getElementById(t.status).appendChild(card);
        });
        Object.keys(c).forEach(k=>document.getElementById('c-'+k).innerText=c[k]);
    }

    let currentTaskId=null;
    function openTaskModal(id){ 
        currentTaskId=id; const t=tasks.find(k=>k.id===id); 
        document.getElementById('m-title').innerText=t.name; document.getElementById('m-status').value=t.status; 
        document.getElementById('m-assignee').value=t.assignee; document.getElementById('m-priority').value=t.priority; 
        document.getElementById('m-tags').value=t.tags?t.tags.join(', '):''; document.getElementById('m-img').value=t.img||''; 
        document.getElementById('m-desc').value=t.desc||''; 
        renderChecklist(t); renderComments(t); renderAttachments(t); updateTimerUI(t); document.getElementById('taskModal').classList.add('active'); 
    }

    // Attachments Logic (Simulated)
    function renderAttachments(t) {
        if(!t.attachments) t.attachments = [];
        const ul = document.getElementById('attachment-list');
        ul.innerHTML = t.attachments.map((a, idx) => `
            <li class="attachment-item">
                <span style="font-size:16px;">${a.type==='file'?'ğŸ“„':'ğŸ”—'}</span>
                <a href="${a.url}" target="_blank">${a.name}</a>
                <button onclick="removeAttachment(${idx})" style="color:red; border:none; background:none;">Ã—</button>
            </li>
        `).join('');
    }
    function fakeUploadFile(input) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            const t = tasks.find(k => k.id === currentTaskId);
            if(!t.attachments) t.attachments = [];
            // Simulate upload by storing name and a fake local URL
            t.attachments.push({ name: file.name, url: '#', type: 'file' });
            saveAndRender(); renderAttachments(t);
            input.value = ''; // clear
        }
    }
    function addAttachmentLink() {
        const input = document.getElementById('attach-link');
        const url = input.value.trim();
        if(url) {
            const t = tasks.find(k => k.id === currentTaskId);
            if(!t.attachments) t.attachments = [];
            t.attachments.push({ name: url, url: url, type: 'link' });
            input.value = '';
            saveAndRender(); renderAttachments(t);
        }
    }
    function removeAttachment(idx) {
        const t = tasks.find(k => k.id === currentTaskId);
        t.attachments.splice(idx, 1);
        saveAndRender(); renderAttachments(t);
    }

    // Timer, Comments, Checklist, etc (Same as v12)
    function toggleTimer(){ const t=tasks.find(k=>k.id===currentTaskId); if(!t.timer)t.timer={totalSeconds:0,isRunning:false}; if(t.timer.isRunning){ t.timer.totalSeconds+=Math.floor((Date.now()-t.timer.lastStartTime)/1000); t.timer.isRunning=false; }else{ t.timer.isRunning=true; t.timer.lastStartTime=Date.now(); } saveAndRender(); updateTimerUI(t); }
    function updateTimerUI(t){ if(!t.timer)t.timer={totalSeconds:0,isRunning:false}; const btn=document.getElementById('m-timer-btn'); btn.innerText=t.timer.isRunning?"â¸ Pause":"â–¶ Start"; btn.style.background=t.timer.isRunning?"#ef4444":"var(--primary)"; updateTimerDisplay(); }
    function updateTimerDisplay(){ if(!currentTaskId||!document.getElementById('taskModal').classList.contains('active'))return; const t=tasks.find(k=>k.id===currentTaskId); if(!t||!t.timer)return; let total=t.timer.totalSeconds; if(t.timer.isRunning)total+=Math.floor((Date.now()-t.timer.lastStartTime)/1000); const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60; document.getElementById('m-time-display').innerText=`${h}h ${m}m ${s}s`; }
    function cloneTask(){ const t=tasks.find(k=>k.id===currentTaskId); const n=JSON.parse(JSON.stringify(t)); n.id='t'+Date.now(); n.name+=" (Copy)"; n.status='todo'; n.timer={totalSeconds:0,isRunning:false}; n.comments=[]; tasks.push(n); saveAndRender(); alert('Cloned'); closeModal('taskModal'); }
    function renderChecklist(t){ const ul=document.getElementById('m-checklist'); ul.innerHTML=''; let d=0; (t.checklist||[]).forEach((i,x)=>{ if(i.done)d++; ul.innerHTML+=`<li class="checklist-item ${i.done?'done':''}"><input type="checkbox" ${i.done?'checked':''} onchange="toggleCheckItem(${x})"><span style="flex:1">${i.text}</span><button onclick="remCheck(${x})" style="color:red;border:none;background:none">Ã—</button></li>` }); document.getElementById('m-progress-bar').style.width=(t.checklist&&t.checklist.length>0?(d/t.checklist.length)*100:0)+'%'; }
    function addCheckItem(){ const v=document.getElementById('new-check-item').value; if(v){ tasks.find(k=>k.id===currentTaskId).checklist.push({text:v,done:false}); document.getElementById('new-check-item').value=''; saveAndRender(); renderChecklist(tasks.find(k=>k.id===currentTaskId)); } }
    function toggleCheckItem(i){ const t=tasks.find(k=>k.id===currentTaskId); t.checklist[i].done=!t.checklist[i].done; saveAndRender(); renderChecklist(t); }
    function remCheck(i){ const t=tasks.find(k=>k.id===currentTaskId); t.checklist.splice(i,1); saveAndRender(); renderChecklist(t); }
    function renderComments(t) { if(!t.comments) t.comments = []; document.getElementById('comment-list').innerHTML = t.comments.map(c => `<li class="comment-item"><div class="comment-header"><span>${c.author || 'Unknown'}</span> <span>${c.time}</span></div><div>${c.text}</div></li>`).join(''); }
    function addComment() { const input = document.getElementById('new-comment'); const text = input.value.trim(); const t = tasks.find(k => k.id === currentTaskId); const author = t.assignee || 'Me'; if(text) { if(!t.comments) t.comments = []; t.comments.push({ text, author, time: new Date().toLocaleString() }); input.value = ''; saveAndRender(); renderComments(t); } }
    function updateTaskStatus(){ const t=tasks.find(k=>k.id===currentTaskId); t.status=document.getElementById('m-status').value; if(t.status==='done') confetti({particleCount:100,spread:70,origin:{y:0.6}}); saveAndRender(); }
    function updateTaskMeta(){ const t=tasks.find(k=>k.id===currentTaskId); t.assignee=document.getElementById('m-assignee').value; t.priority=document.getElementById('m-priority').value; t.img=document.getElementById('m-img').value; t.desc=document.getElementById('m-desc').value; t.tags=document.getElementById('m-tags').value.split(',').filter(x=>x); saveAndRender(); }
    function deleteCurrentTask(){ if(confirm('Delete?')){ tasks=tasks.filter(k=>k.id!==currentTaskId); saveAndRender(); closeModal('taskModal'); } }
    function openTeamModal(){ renderTeamList(); document.getElementById('teamModal').classList.add('active'); }
    function addMember(){ const v=document.getElementById('new-member-name').value.trim(); if(v&&!members.includes(v)){ members.push(v); saveMembers(); renderTeamList(); renderMembers(); document.getElementById('new-member-name').value=''; } }
    function removeMember(n){ if(confirm('Remove?')){ members=members.filter(m=>m!==n); saveMembers(); renderTeamList(); renderMembers(); } }
    function renderTeamList(){ document.getElementById('team-list-display').innerHTML=members.map(m=>`<button style="padding:5px 10px;border:1px solid #ddd;border-radius:15px;background:#fff" onclick="removeMember('${m}')">${m} Ã—</button>`).join(''); }
    function renderMembers(){ const txt=currentLang==='zh'?'(æœªæŒ‡æ´¾)':'(Unassigned)'; const all=currentLang==='zh'?'æ‰€æœ‰æˆå“¡':'All Members'; const opts=`<option value="">${txt}</option>`+members.map(m=>`<option value="${m}">${m}</option>`).join(''); document.getElementById('t-assignee').innerHTML=opts; document.getElementById('m-assignee').innerHTML=opts; document.getElementById('s-member').innerHTML=`<option value="">${all}</option>`+members.map(m=>`<option value="${m}">${m}</option>`).join(''); }
    function allowDrop(ev){ev.preventDefault();}
    function drop(ev){ ev.preventDefault(); const id=ev.dataTransfer.getData("text"); const t=ev.target.closest('.task-list'); if(t){ const task=tasks.find(k=>k.id===id); if(task.status!==t.id){ task.status=t.id; if(t.id==='done') confetti({particleCount:100,spread:70,origin:{y:0.6}}); saveAndRender(); } } }
    function openDashboard(){ document.getElementById('dashboardModal').classList.add('active'); renderCharts(); }
    function renderCharts(){ if(window.C1)window.C1.destroy(); if(window.C2)window.C2.destroy(); const sData=['todo','inprogress','onhold','blocked','done'].map(s=>tasks.filter(t=>t.status===s).length); const mCount={}; members.forEach(m=>mCount[m]=0); mCount['Unassigned']=0; tasks.forEach(t=>{mCount[t.assignee||'Unassigned']++}); window.C1=new Chart(document.getElementById('statusChart'),{type:'doughnut',data:{labels:['Todo','In Prog','Hold','Blocked','Done'],datasets:[{data:sData,backgroundColor:['#cbd5e1','#3b82f6','#f59e0b','#ef4444','#10b981']}]}}); window.C2=new Chart(document.getElementById('memberChart'),{type:'bar',data:{labels:Object.keys(mCount),datasets:[{label:'Tasks',data:Object.values(mCount),backgroundColor:'#4f46e5'}]}}); }
    function logActivity(msg){ activities.unshift({msg,time:new Date().toLocaleString()}); if(activities.length>50)activities.pop(); localStorage.setItem('v13_activities',JSON.stringify(activities)); }
    function openLogModal(){ document.getElementById('log-list').innerHTML=activities.map(a=>`<li class="log-item"><span>${a.msg}</span> <span style="font-size:10px;color:#999">${a.time}</span></li>`).join(''); document.getElementById('logModal').classList.add('active'); }
    function clearLog(){ activities=[]; localStorage.setItem('v13_activities','[]'); openLogModal(); }
    function saveAndRender(){ localStorage.setItem('v13_tasks',JSON.stringify(tasks)); renderKanban(); }
    function saveMembers(){ localStorage.setItem('v13_members',JSON.stringify(members)); }
    function closeModal(id){ document.getElementById(id).classList.remove('active'); }
    function toggleTheme(){ const d=document.documentElement; const isDark=d.getAttribute('data-theme')==='dark'; d.setAttribute('data-theme',isDark?'light':'dark'); localStorage.setItem('theme',isDark?'light':'dark'); }
    function exportData(){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify({tasks,members,activities})],{type:'application/json'})); a.download='backup_v13.json'; a.click(); }
    function importData(e){ const r=new FileReader(); r.onload=(ev)=>{ const d=JSON.parse(ev.target.result); if(d.tasks)tasks=d.tasks; if(d.members)members=d.members; saveAndRender(); saveMembers(); renderMembers(); alert('Restored!'); }; r.readAsText(e.target.files[0]); }
</script>
</body>
</html>